#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#
library(shiny)
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(plotly)
library(chilemapas)
# Lectura bases
cod <- readxl::read_xlsx("codigo_comunas.xlsx") %>%
janitor::clean_names() %>%
rename('codigo_comuna' = cut_codigo_unico_territorial) %>%
mutate(comuna = chartr('√°√©√≠√≥√∫√º','aeiouu',tolower(nombre)))
df_elec <- readRDS("base_elec.rds") %>%
janitor::clean_names() %>%
mutate(comuna = chartr('√°√©√≠√≥√∫√º','aeiouu',tolower(comuna)),
comuna = case_when((comuna == 'aisen') ~ 'aysen',
(comuna == 'calera') ~ 'la calera',
(comuna == 'marchigue') ~ 'marchihue',
(comuna == 'tiltil') ~ 'til til',
TRUE ~ comuna))
df_elec2 <- left_join(df_elec,
cod,
by = 'comuna') %>%
select(-provincia.y)
# Incorporar nuevas regiones
df_elec2 <- df_elec2 %>%
mutate(id_region = (ifelse((comuna %in% c('corral', 'futrono', 'la union', 'lago ranco', 'lanco', 'los lagos', 'mafil', 'mariquina', 'paillaco', 'panguipulli', 'rio bueno', 'valdivia')),14,id_region)),
id_region = (ifelse((comuna %in% c('arica','camarones','general lagos','putre')),15,id_region)))
# Diferenciar entre elecciones (primera y segunda vuelta no siempre fueron en a√±os diferentes)
df_elec2 <- df_elec2 %>%
mutate(vuelta = case_when((votacion_presidencial == 'UNICA VOTACI√ìN')~ '1',
(votacion_presidencial == 'PRIMERA VOTACI√ìN')~ '1',
(votacion_presidencial == 'SEGUNDA VOTACI√ìN')~ '2',
TRUE ~ NA_character_),
ano_de_eleccion = case_when((ano_de_eleccion == 2000)~1999,
(ano_de_eleccion == 2006)~2005,
(ano_de_eleccion == 2010)~2009,
TRUE ~ ano_de_eleccion),
eleccion = paste0(vuelta,'-',ano_de_eleccion))
df_elec2$eleccion <- factor(df_elec2$eleccion, levels = c('1-1989',
'1-1993',
'1-1999',
'2-1999',
'1-2005',
'2-2005',
'1-2009',
'2-2009',
'1-2013',
'2-2013',
'1-2017',
'2-2017'))
# Extracci√≥n de nulos y blancos
df_elec2 <- df_elec2 %>%
filter(candidato_a != 'VOTOS NULOS',
candidato_a != 'VOTOS EN BLANCO')
# C√°lculo de total de votos por candidato por comuna y regi√≥n
df_elec_calc <- df_elec2 %>%
group_by(codigo_comuna,eleccion) %>%
mutate(tot_com = sum(votos_totales),
por_com = (votos_totales/tot_com)) %>%
group_by(candidato_a,codigo_comuna,eleccion) %>%
mutate(tot_cand_com = round(sum(por_com),2)) %>%
ungroup() %>%
group_by(eleccion) %>%
mutate(tot_nac = sum(votos_totales)) %>%
group_by(candidato_a,eleccion) %>%
mutate(votos_cand_nac = sum(votos_totales),
tot_cand_nac = round(votos_cand_nac/tot_nac,2)) %>%
ungroup()
# Agrupaci√≥n por coaliciones
df_elec_calc <- df_elec_calc %>%
mutate(coalicion =  case_when((candidato_a %in% c('HERNAN BUCHI', 'ARTURO ALESSANDRI', 'JOAQUIN LAVIN', 'SEBASTIAN PI√ëERA', 'EVELYN MATTHEI FORNET', 'SEBASTIAN PI√ëERA ECHENIQUE'))~'Chile Vamos y anteriores',
(candidato_a %in% c('PATRICIO AYLWIN', 'EDUARDO FREI', 'RICARDO LAGOS', 'MICHELLE BACHELET', 'MICHELLE BACHELET JERIA', 'CAROLINA GOIC BOROEVIC', 'ALEJANDRO  GUILLIER ALVAREZ')~ 'Nueva Mayor√≠a y anteriores'),
TRUE ~ 'Otros'))
# C√°lculo de porcentajes por coalici√≥n por comuna
df_elec_com <- df_elec_calc %>%
count(eleccion,codigo_comuna,comuna,candidato_a,tot_cand_com,coalicion) %>%
group_by(codigo_comuna,coalicion,eleccion) %>%
mutate(tot_coal_com = sum(tot_cand_com)) %>%
select(-n)
# C√°lculo de porcentajes por coalici√≥n nacional
df_elec_nac <- df_elec_calc %>%
count(eleccion,candidato_a,tot_cand_nac,coalicion) %>%
group_by(coalicion,eleccion) %>%
mutate(tot_coal_nac = sum(tot_cand_nac)) %>%
count(eleccion,coalicion,tot_coal_nac) %>%
select(-n)
# Uni√≥n con chilemapas
mapa <- mapa_comunas %>%
left_join(df_elec_com, by = 'codigo_comuna') %>%
mutate(region = as.numeric(codigo_region)) %>%
left_join(df_elec_calc %>% select(eleccion,tot_nac),by='eleccion')
# Para mapas finales
df_map <- mapa %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
library(shiny)
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(plotly)
library(chilemapas)
library(shiny)
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(plotly)
library(chilemapas)
# Lectura bases
cod <- readxl::read_xlsx("codigo_comunas.xlsx") %>%
janitor::clean_names() %>%
rename('codigo_comuna' = cut_codigo_unico_territorial) %>%
mutate(comuna = chartr('√°√©√≠√≥√∫√º','aeiouu',tolower(nombre)))
df_elec <- readRDS("base_elec.rds") %>%
janitor::clean_names() %>%
mutate(comuna = chartr('√°√©√≠√≥√∫√º','aeiouu',tolower(comuna)),
comuna = case_when((comuna == 'aisen') ~ 'aysen',
(comuna == 'calera') ~ 'la calera',
(comuna == 'marchigue') ~ 'marchihue',
(comuna == 'tiltil') ~ 'til til',
TRUE ~ comuna))
df_elec2 <- left_join(df_elec,
cod,
by = 'comuna') %>%
select(-provincia.y)
# Incorporar nuevas regiones
df_elec2 <- df_elec2 %>%
mutate(id_region = (ifelse((comuna %in% c('corral', 'futrono', 'la union', 'lago ranco', 'lanco', 'los lagos', 'mafil', 'mariquina', 'paillaco', 'panguipulli', 'rio bueno', 'valdivia')),14,id_region)),
id_region = (ifelse((comuna %in% c('arica','camarones','general lagos','putre')),15,id_region)))
# Diferenciar entre elecciones (primera y segunda vuelta no siempre fueron en a√±os diferentes)
df_elec2 <- df_elec2 %>%
mutate(vuelta = case_when((votacion_presidencial == 'UNICA VOTACI√ìN')~ '1',
(votacion_presidencial == 'PRIMERA VOTACI√ìN')~ '1',
(votacion_presidencial == 'SEGUNDA VOTACI√ìN')~ '2',
TRUE ~ NA_character_),
ano_de_eleccion = case_when((ano_de_eleccion == 2000)~1999,
(ano_de_eleccion == 2006)~2005,
(ano_de_eleccion == 2010)~2009,
TRUE ~ ano_de_eleccion),
eleccion = paste0(vuelta,'-',ano_de_eleccion))
df_elec2$eleccion <- factor(df_elec2$eleccion, levels = c('1-1989',
'1-1993',
'1-1999',
'2-1999',
'1-2005',
'2-2005',
'1-2009',
'2-2009',
'1-2013',
'2-2013',
'1-2017',
'2-2017'))
# Extracci√≥n de nulos y blancos
df_elec2 <- df_elec2 %>%
filter(candidato_a != 'VOTOS NULOS',
candidato_a != 'VOTOS EN BLANCO')
# C√°lculo de total de votos por candidato por comuna y regi√≥n
df_elec_calc <- df_elec2 %>%
group_by(codigo_comuna,eleccion) %>%
mutate(tot_com = sum(votos_totales),
por_com = (votos_totales/tot_com)) %>%
group_by(candidato_a,codigo_comuna,eleccion) %>%
mutate(tot_cand_com = round(sum(por_com),2)) %>%
ungroup() %>%
group_by(eleccion) %>%
mutate(tot_nac = sum(votos_totales)) %>%
group_by(candidato_a,eleccion) %>%
mutate(votos_cand_nac = sum(votos_totales),
tot_cand_nac = round(votos_cand_nac/tot_nac,2)) %>%
ungroup()
# Agrupaci√≥n por coaliciones
df_elec_calc <- df_elec_calc %>%
mutate(coalicion =  case_when((candidato_a %in% c('HERNAN BUCHI', 'ARTURO ALESSANDRI', 'JOAQUIN LAVIN', 'SEBASTIAN PI√ëERA', 'EVELYN MATTHEI FORNET', 'SEBASTIAN PI√ëERA ECHENIQUE'))~'Chile Vamos y anteriores',
(candidato_a %in% c('PATRICIO AYLWIN', 'EDUARDO FREI', 'RICARDO LAGOS', 'MICHELLE BACHELET', 'MICHELLE BACHELET JERIA', 'CAROLINA GOIC BOROEVIC', 'ALEJANDRO  GUILLIER ALVAREZ')~ 'Nueva Mayor√≠a y anteriores'),
TRUE ~ 'Otros'))
# C√°lculo de porcentajes por coalici√≥n por comuna
df_elec_com <- df_elec_calc %>%
count(eleccion,codigo_comuna,comuna,candidato_a,tot_cand_com,coalicion) %>%
group_by(codigo_comuna,coalicion,eleccion) %>%
mutate(tot_coal_com = sum(tot_cand_com)) %>%
select(-n)
# C√°lculo de porcentajes por coalici√≥n nacional
df_elec_nac <- df_elec_calc %>%
count(eleccion,candidato_a,tot_cand_nac,coalicion) %>%
group_by(coalicion,eleccion) %>%
mutate(tot_coal_nac = sum(tot_cand_nac)) %>%
count(eleccion,coalicion,tot_coal_nac) %>%
select(-n)
# Uni√≥n con chilemapas
mapa <- mapa_comunas %>%
left_join(df_elec_com, by = 'codigo_comuna') %>%
mutate(region = as.numeric(codigo_region)) %>%
left_join(df_elec_calc %>% select(eleccion,tot_nac),by='eleccion')
# Uni√≥n con chilemapas
mapa <- mapa_comunas %>%
left_join(df_elec_com, by = 'codigo_comuna') %>%
mutate(region = as.numeric(codigo_region))
# Para mapas finales
df_map <- mapa %>%
left_join(df_elec_calc %>% select(eleccion,tot_nac),by='eleccion') %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
# Para mapas finales
df_map <- mapa %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
View(df_map)
df_map2 <- left_join(df_map,df_elec_calc %>% select(eleccion,tot_nac),
by='eleccion')
# C√°lculo de porcentajes por coalici√≥n por comuna
df_elec_com <- df_elec_calc %>%
count(eleccion,codigo_comuna,comuna,candidato_a,tot_cand_com,coalicion,tot_nac) %>%
group_by(codigo_comuna,coalicion,eleccion) %>%
mutate(tot_coal_com = sum(tot_cand_com)) %>%
select(-n)
# C√°lculo de porcentajes por coalici√≥n nacional
df_elec_nac <- df_elec_calc %>%
count(eleccion,candidato_a,tot_cand_nac,coalicion) %>%
group_by(coalicion,eleccion) %>%
mutate(tot_coal_nac = sum(tot_cand_nac)) %>%
count(eleccion,coalicion,tot_coal_nac) %>%
select(-n)
# Uni√≥n con chilemapas
mapa <- mapa_comunas %>%
left_join(df_elec_com, by = 'codigo_comuna') %>%
mutate(region = as.numeric(codigo_region))
# Para mapas finales
df_map <- mapa %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
View(mapa)
# Para mapas finales
df_map <- mapa %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna,tot_nac) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
df_map %>%
filter(eleccion == input$eleccion_2) %>%
ggplot()+
stat_sf_coordinates(aes(geometry = geometry, color = gan_f))+
theme_classic()+
theme(axis.line.x = element_blank(),
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
axis.title.x = element_blank(),
axis.line.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
axis.title.y = element_blank())+
coord_sf(xlim = c(-80, -60),expand = TRUE)+
labs(color = '')+
scale_color_manual(values = c('blue','red','orange'), breaks = c('Chile Vamos y anteriores', 'Nueva Mayor√≠a y anteriores','Otros'))
runApp()
capt <- df_map %>% filter(eleccion == input$eleccion_2) %>% mean(tot_nac)
runApp()
runApp()
runApp()
df_map %>% filter(eleccion == '1-1989') %>% mean(tot_nac)
df_map %>% filter(eleccion == '1-1989') %>% select(tot_nac)
df_map %>% filter(eleccion == '1-1989') %>% ungroup() %>% mean(tot_nac)
df_map %>% filter(eleccion == '1-1989') %>% ungroup() %>% mutate(capt = mean(tot_nac))
df_map %>% filter(eleccion == '1-1989') %>% ungroup() %>% mutate(capt = mean(tot_nac)) %>% select(capt)
capt <- df_map %>% filter(eleccion == input$eleccion_2) %>% select(tot_nac)
df_map %>%
select(tot_nac)
df_map %>%
filter(eleccion %in% c('1-1993','1-1999')) %>%
select(tot_nac)
df_map %>%
filter(eleccion %in% c('1-1993','1-1999')) %>%
select(tot_nac)
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
select(tot_nac)
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_point()+
geom_text(aes(label = tot_nac))
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_text(aes(label = tot_nac))
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_text(aes(label = tot_nac),size=3)
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_text(aes(label = tot_nac),size=3)+
theme(axis.line.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
axis.title.y = element_blank()) +
labs(x = 'Elecci√≥n')
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_text(aes(label = tot_nac),size=3)+
theme_classic()+
theme(axis.line.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
axis.title.y = element_blank()) +
labs(x = 'Elecci√≥n')
df_map %>%
filter(eleccion %in% c('1-1993','1-1999'),
comuna == 'santiago') %>%
ggplot(aes(x=eleccion,y=tot_nac))+
geom_text(aes(label = tot_nac),size=3)+
theme_classic()+
theme(axis.line.x = element_blank(),
axis.line.y = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_blank(),
axis.title.y = element_blank()) +
labs(x = 'Elecci√≥n')
runApp()
runApp()
runApp()
runApp()
setwd("../dashboard_elecciones/")
library(shiny)
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(plotly)
library(chilemapas)
# Lectura bases
cod <- readxl::read_xlsx("codigo_comunas.xlsx") %>%
janitor::clean_names() %>%
rename('codigo_comuna' = cut_codigo_unico_territorial) %>%
mutate(comuna = chartr('√°√©√≠√≥√∫','aeiouu',tolower(nombre)))
df_elec <- readRDS("base_elec.rds") %>%
janitor::clean_names() %>%
mutate(comuna = chartr('√°√©√≠√≥√∫','aeiouu',tolower(comuna)),
comuna = case_when((comuna == 'aisen') ~ 'aysen',
(comuna == 'calera') ~ 'la calera',
(comuna == 'marchigue') ~ 'marchihue',
(comuna == 'tiltil') ~ 'til til',
TRUE ~ comuna))
df_elec2 <- left_join(df_elec,
cod,
by = 'comuna') %>%
select(-provincia.y)
# Incorporar nuevas regiones
df_elec2 <- df_elec2 %>%
mutate(id_region = (ifelse((comuna %in% c('corral', 'futrono', 'la union', 'lago ranco', 'lanco', 'los lagos', 'mafil', 'mariquina', 'paillaco', 'panguipulli', 'rio bueno', 'valdivia')),14,id_region)),
id_region = (ifelse((comuna %in% c('arica','camarones','general lagos','putre')),15,id_region)))
# Diferenciar entre elecciones (primera y segunda vuelta no siempre fueron en a√É¬±os diferentes)
df_elec2 <- df_elec2 %>%
mutate(vuelta = case_when((votacion_presidencial == 'UNICA VOTACI√ìN')~ '1',
(votacion_presidencial == 'PRIMERA VOTACI√ìN')~ '1',
(votacion_presidencial == 'SEGUNDA VOTACI√ìN')~ '2',
TRUE ~ NA_character_),
ano_de_eleccion = case_when((ano_de_eleccion == 2000)~1999,
(ano_de_eleccion == 2006)~2005,
(ano_de_eleccion == 2010)~2009,
TRUE ~ ano_de_eleccion),
eleccion = paste0(vuelta,'-',ano_de_eleccion))
df_elec2$eleccion <- factor(df_elec2$eleccion, levels = c('1-1989',
'1-1993',
'1-1999',
'2-1999',
'1-2005',
'2-2005',
'1-2009',
'2-2009',
'1-2013',
'2-2013',
'1-2017',
'2-2017'))
# Extracci√É¬≥n de nulos y blancos
df_elec2 <- df_elec2 %>%
filter(candidato_a != 'VOTOS NULOS',
candidato_a != 'VOTOS EN BLANCO')
# C√É¬°lculo de total de votos por candidato por comuna y regi√É¬≥n
df_elec_calc <- df_elec2 %>%
group_by(codigo_comuna,eleccion) %>%
mutate(tot_com = sum(votos_totales),
por_com = (votos_totales/tot_com)) %>%
group_by(candidato_a,codigo_comuna,eleccion) %>%
mutate(tot_cand_com = round(sum(por_com),2)) %>%
ungroup() %>%
group_by(eleccion) %>%
mutate(tot_nac = sum(votos_totales)) %>%
group_by(candidato_a,eleccion) %>%
mutate(votos_cand_nac = sum(votos_totales),
tot_cand_nac = round(votos_cand_nac/tot_nac,2)) %>%
ungroup()
# Agrupaci√É¬≥n por coaliciones
df_elec_calc <- df_elec_calc %>%
mutate(coalicion =  case_when((candidato_a %in% c('HERNAN BUCHI', 'ARTURO ALESSANDRI', 'JOAQUIN LAVIN', 'SEBASTIAN PI√É¬ëERA', 'EVELYN MATTHEI FORNET', 'SEBASTIAN PI√É¬ëERA ECHENIQUE'))~'Chile Vamos y anteriores',
(candidato_a %in% c('PATRICIO AYLWIN', 'EDUARDO FREI', 'RICARDO LAGOS', 'MICHELLE BACHELET', 'MICHELLE BACHELET JERIA', 'CAROLINA GOIC BOROEVIC', 'ALEJANDRO  GUILLIER ALVAREZ')~ 'Nueva Mayor√É≠a y anteriores'),
TRUE ~ 'Otros'))
# C√É¬°lculo de porcentajes por coalici√É¬≥n por comuna
df_elec_com <- df_elec_calc %>%
count(eleccion,codigo_comuna,comuna,candidato_a,tot_cand_com,coalicion,tot_nac) %>%
group_by(codigo_comuna,coalicion,eleccion) %>%
mutate(tot_coal_com = sum(tot_cand_com)) %>%
select(-n)
# C√É¬°lculo de porcentajes por coalici√É¬≥n nacional
df_elec_nac <- df_elec_calc %>%
count(eleccion,candidato_a,tot_cand_nac,coalicion) %>%
group_by(coalicion,eleccion) %>%
mutate(tot_coal_nac = sum(tot_cand_nac)) %>%
count(eleccion,coalicion,tot_coal_nac) %>%
select(-n)
# Uni√É¬≥n con chilemapas
mapa <- mapa_comunas %>%
left_join(df_elec_com, by = 'codigo_comuna') %>%
mutate(region = as.numeric(codigo_region))
# Para mapas finales
df_map <- mapa %>%
group_by(eleccion,comuna,coalicion) %>%
sjmisc::add_id() %>%
filter(ID == 1) %>%
select(coalicion,geometry,tot_coal_com,eleccion,comuna,tot_nac) %>%
ungroup() %>%
group_by(eleccion,comuna) %>%
mutate(ganador = (max(tot_coal_com)),
aux = (ganador == tot_coal_com),
gan_f = ifelse((aux == TRUE),coalicion,0)) %>%
filter(gan_f != 0)
runApp()
runApp()
runApp()
runApp()
shiny::runApp()
